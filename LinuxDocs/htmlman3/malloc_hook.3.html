<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
  <title>
   malloc_hook(3) &mdash; Linux manual pages
  </title>
  <link href="../stylesheet/manpages.css" rel="stylesheet" type="text/css"/>
  <link href="../index.html" rel="home" title="malloc_hook(3) &mdash; Linux manual pages"/>
  <script src="../stylesheet/manpages.js" type="text/javascript" xml:space="preserve">
  </script>
  <link href="../stylesheet/icon.gif" rel="icon" type="image/gif"/>
 </head>
 <body>
  <div class="refentry">
   <a id="malloc-hook.3" name="malloc-hook.3" shape="rect">
   </a>
   <div class="titlepage">
   </div>
   <div class="refnamediv">
    <h2>
     Name
    </h2>
    <p>
     __malloc_hook, __malloc_initialize_hook, __memalign_hook,
      __free_hook, __realloc_hook, __after_morecore_hook &mdash;
      malloc debugging variables
    </p>
   </div>
   <div class="refsynopsisdiv">
    <h2>
     Synopsis
    </h2>
    <div class="funcsynopsis">
     <pre class="funcsynopsisinfo" xml:space="preserve">
#include &lt;malloc.h&gt;
</pre>
     <table border="0" class="funcprototype-table" style="cellspacing: 0; cellpadding: 0;" summary="Function synopsis">
      <tr>
       <td colspan="1" rowspan="1">
        <code class="funcdef">
         void
         <strong>
          *
         </strong>
         (
        </code>
       </td>
       <td colspan="1" rowspan="1">
        *__malloc_hook)(size_t
        <var class="pdparam">
         size
        </var>
        ,
       </td>
      </tr>
      <tr>
       <td colspan="1" rowspan="1">
        &nbsp;
       </td>
       <td colspan="1" rowspan="1">
        const void *
        <var class="pdparam">
         caller
        </var>
        <code>
         )
        </code>
        ;
       </td>
      </tr>
     </table>
     <div class="funcprototype-spacer">
      &nbsp;
     </div>
    </div>
    <div class="funcsynopsis">
     <table border="0" class="funcprototype-table" style="cellspacing: 0; cellpadding: 0;" summary="Function synopsis">
      <tr>
       <td colspan="1" rowspan="1">
        <code class="funcdef">
         void
         <strong>
          *
         </strong>
         (
        </code>
       </td>
       <td colspan="1" rowspan="1">
        *__realloc_hook)(void *
        <var class="pdparam">
         ptr
        </var>
        ,
       </td>
      </tr>
      <tr>
       <td colspan="1" rowspan="1">
        &nbsp;
       </td>
       <td colspan="1" rowspan="1">
        size_t
        <var class="pdparam">
         size
        </var>
        ,
       </td>
      </tr>
      <tr>
       <td colspan="1" rowspan="1">
        &nbsp;
       </td>
       <td colspan="1" rowspan="1">
        const void *
        <var class="pdparam">
         caller
        </var>
        <code>
         )
        </code>
        ;
       </td>
      </tr>
     </table>
     <div class="funcprototype-spacer">
      &nbsp;
     </div>
    </div>
    <div class="funcsynopsis">
     <table border="0" class="funcprototype-table" style="cellspacing: 0; cellpadding: 0;" summary="Function synopsis">
      <tr>
       <td colspan="1" rowspan="1">
        <code class="funcdef">
         void
         <strong>
          *
         </strong>
         (
        </code>
       </td>
       <td colspan="1" rowspan="1">
        *__memalign_hook)(size_t
        <var class="pdparam">
         alignment
        </var>
        ,
       </td>
      </tr>
      <tr>
       <td colspan="1" rowspan="1">
        &nbsp;
       </td>
       <td colspan="1" rowspan="1">
        size_t
        <var class="pdparam">
         size
        </var>
        ,
       </td>
      </tr>
      <tr>
       <td colspan="1" rowspan="1">
        &nbsp;
       </td>
       <td colspan="1" rowspan="1">
        const void *
        <var class="pdparam">
         caller
        </var>
        <code>
         )
        </code>
        ;
       </td>
      </tr>
     </table>
     <div class="funcprototype-spacer">
      &nbsp;
     </div>
    </div>
    <div class="funcsynopsis">
     <table border="0" class="funcprototype-table" style="cellspacing: 0; cellpadding: 0;" summary="Function synopsis">
      <tr>
       <td colspan="1" rowspan="1">
        <code class="funcdef">
         <strong>
          void
         </strong>
         (
        </code>
       </td>
       <td colspan="1" rowspan="1">
        *__free_hook)(void *
        <var class="pdparam">
         ptr
        </var>
        ,
       </td>
      </tr>
      <tr>
       <td colspan="1" rowspan="1">
        &nbsp;
       </td>
       <td colspan="1" rowspan="1">
        const void *
        <var class="pdparam">
         caller
        </var>
        <code>
         )
        </code>
        ;
       </td>
      </tr>
     </table>
     <div class="funcprototype-spacer">
      &nbsp;
     </div>
    </div>
    <div class="funcsynopsis">
     <table border="0" class="funcprototype-table" style="cellspacing: 0; cellpadding: 0;" summary="Function synopsis">
      <tr>
       <td colspan="1" rowspan="1">
        <code class="funcdef">
         <strong>
          void
         </strong>
         (
        </code>
       </td>
       <td colspan="1" rowspan="1">
        *__malloc_initialize_hook)(
        <var class="pdparam">
         void
        </var>
        <code>
         )
        </code>
        ;
       </td>
      </tr>
     </table>
     <div class="funcprototype-spacer">
      &nbsp;
     </div>
    </div>
    <div class="funcsynopsis">
     <table border="0" class="funcprototype-table" style="cellspacing: 0; cellpadding: 0;" summary="Function synopsis">
      <tr>
       <td colspan="1" rowspan="1">
        <code class="funcdef">
         <strong>
          void
         </strong>
         (
        </code>
       </td>
       <td colspan="1" rowspan="1">
        *__after_morecore_hook)(
        <var class="pdparam">
         void
        </var>
        <code>
         )
        </code>
        ;
       </td>
      </tr>
     </table>
     <div class="funcprototype-spacer">
      &nbsp;
     </div>
    </div>
   </div>
   <div class="refsect1">
    <a id="malloc-hook-3_sect1" name="malloc-hook-3_sect1" shape="rect">
    </a>
    <h2>
     DESCRIPTION
    </h2>
    <p>
     The GNU C library lets you modify the behavior of
     <a class="link" href="../htmlman3/malloc.3.html" shape="rect" target="_top">
      <span class="citerefentry">
       <span class="refentrytitle">
        malloc
       </span>
       (3)
      </span>
     </a>
     ,
     <a class="link" href="../htmlman3/malloc.3.html" shape="rect" target="_top">
      <span class="citerefentry">
       <span class="refentrytitle">
        realloc
       </span>
       (3)
      </span>
     </a>
     , and
     <a class="link" href="../htmlman3/malloc.3.html" shape="rect" target="_top">
      <span class="citerefentry">
       <span class="refentrytitle">
        free
       </span>
       (3)
      </span>
     </a>
     by specifying
      appropriate hook functions. You can use these hooks to help
      you debug programs that use dynamic memory allocation, for
      example.
    </p>
    <p>
     The variable
     <code class="varname">
      __malloc_initialize_hook
     </code>
     points at a
      function that is called once when the malloc implementation
      is initialized. This is a weak variable, so it can be
      overridden in the application with a definition like the
      following:
    </p>
    <div class="informalexample">
     <pre class="programlisting" xml:space="preserve">
    void (*__malloc_initialize_hook)(void) = my_init_hook;
</pre>
    </div>
    <p>
     Now the function
     <code class="varname">
      my_init_hook
     </code>
     () can do the initialization of
      all hooks.
    </p>
    <p>
     The four functions pointed to by
     <code class="varname">
      __malloc_hook
     </code>
     ,
     <code class="varname">
      __realloc_hook
     </code>
     ,
     <code class="varname">
      __memalign_hook
     </code>
     ,
     <code class="varname">
      __free_hook
     </code>
     have a prototype like the
      functions
     <a class="link" href="../htmlman3/malloc.3.html" shape="rect" target="_top">
      <span class="citerefentry">
       <span class="refentrytitle">
        malloc
       </span>
       (3)
      </span>
     </a>
     ,
     <a class="link" href="../htmlman3/malloc.3.html" shape="rect" target="_top">
      <span class="citerefentry">
       <span class="refentrytitle">
        realloc
       </span>
       (3)
      </span>
     </a>
     ,
     <a class="link" href="../htmlman3/posix_memalign.3.html" shape="rect" target="_top">
      <span class="citerefentry">
       <span class="refentrytitle">
        memalign
       </span>
       (3)
      </span>
     </a>
     ,
     <a class="link" href="../htmlman3/malloc.3.html" shape="rect" target="_top">
      <span class="citerefentry">
       <span class="refentrytitle">
        free
       </span>
       (3)
      </span>
     </a>
     , respectively,
      except that they have a final argument
     <em class="parameter">
      <code>
       caller
      </code>
     </em>
     that gives the address
      of the caller of
     <a class="link" href="../htmlman3/malloc.3.html" shape="rect" target="_top">
      <span class="citerefentry">
       <span class="refentrytitle">
        malloc
       </span>
       (3)
      </span>
     </a>
     , etc.
    </p>
    <p>
     The variable
     <code class="varname">
      __after_morecore_hook
     </code>
     points at a function
      that is called each time after
     <a class="link" href="../htmlman2/brk.2.html" shape="rect" target="_top">
      <span class="citerefentry">
       <span class="refentrytitle">
        sbrk
       </span>
       (2)
      </span>
     </a>
     was asked for more
      memory.
    </p>
   </div>
   <div class="refsect1">
    <a id="malloc-hook-3_sect2" name="malloc-hook-3_sect2" shape="rect">
    </a>
    <h2>
     CONFORMING TO
    </h2>
    <p>
     These functions are GNU extensions.
    </p>
   </div>
   <div class="refsect1">
    <a id="malloc-hook-3_sect3" name="malloc-hook-3_sect3" shape="rect">
    </a>
    <h2>
     NOTES
    </h2>
    <p>
     The use of these hook functions is not safe in
      multithreaded programs, and they are now deprecated.
      Programmers should instead preempt calls to the relevant
      functions by defining and exporting functions such as
      "malloc" and "free".
    </p>
   </div>
   <div class="refsect1">
    <a id="malloc-hook-3_sect4" name="malloc-hook-3_sect4" shape="rect">
    </a>
    <h2>
     EXAMPLE
    </h2>
    <p>
     Here is a short example of how to use these variables.
    </p>
    <div class="informalexample">
     <pre class="programlisting" xml:space="preserve">
#include &lt;stdio.h&gt;
#include &lt;malloc.h&gt;

/* Prototypes for our hooks.  */
static void my_init_hook(void);
static void *my_malloc_hook(size_t, const void *);

/* Variables to save original hooks. */
static void *(*old_malloc_hook)(size_t, const void *);

/* Override initializing hook from the C library. */
void (*__malloc_initialize_hook) (void) = my_init_hook;

static void
my_init_hook(void)
{
    old_malloc_hook = __malloc_hook;
    __malloc_hook = my_malloc_hook;
}

static void *
my_malloc_hook(size_t size, const void *caller)
{
    void *result;

    /* Restore all old hooks */
    __malloc_hook = old_malloc_hook;

    /* Call recursively */
    result = malloc(size);

    /* Save underlying hooks */
    old_malloc_hook = __malloc_hook;

    /* printf() might call malloc(), so protect it too. */
    printf("malloc(%u) called from %p returns %p\n",
            (unsigned int) size, caller, result);

    /* Restore our own hooks */
    __malloc_hook = my_malloc_hook;

    return result;
}
</pre>
    </div>
   </div>
   <div class="refsect1">
    <a id="malloc-hook-3_sect5" name="malloc-hook-3_sect5" shape="rect">
    </a>
    <h2>
     SEE ALSO
    </h2>
    <p>
     <a class="link" href="../htmlman3/mallinfo.3.html" shape="rect" target="_top">
      <span class="citerefentry">
       <span class="refentrytitle">
        mallinfo
       </span>
       (3)
      </span>
     </a>
     ,
     <a class="link" href="../htmlman3/malloc.3.html" shape="rect" target="_top">
      <span class="citerefentry">
       <span class="refentrytitle">
        malloc
       </span>
       (3)
      </span>
     </a>
     ,
     <a class="link" href="../htmlman3/mcheck.3.html" shape="rect" target="_top">
      <span class="citerefentry">
       <span class="refentrytitle">
        mcheck
       </span>
       (3)
      </span>
     </a>
     ,
     <a class="link" href="../htmlman3/mtrace.3.html" shape="rect" target="_top">
      <span class="citerefentry">
       <span class="refentrytitle">
        mtrace
       </span>
       (3)
      </span>
     </a>
    </p>
   </div>
   <div class="colophon">
    <a id="malloc-hook-3_sect6" name="malloc-hook-3_sect6" shape="rect">
    </a>
    <h2>
     COLOPHON
    </h2>
    <p>
     This page is part of release 3.72 of the Linux
     <em class="replaceable">
      <code>
       man-pages
      </code>
     </em>
     project. A
      description of the project, information about reporting bugs,
      and the latest version of this page, can be found at
      http://www.kernel.org/doc/man&minus;pages/.
    </p>
   </div>
  </div>
 </body>
</html>
